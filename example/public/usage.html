<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Usage Dashboard | n8n</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --bg-card-hover: #22222e;
      --accent: #ea4b71;
      --accent-soft: rgba(234, 75, 113, 0.15);
      --success: #10b981;
      --success-soft: rgba(16, 185, 129, 0.15);
      --warning: #f59e0b;
      --warning-soft: rgba(245, 158, 11, 0.15);
      --error: #ef4444;
      --error-soft: rgba(239, 68, 68, 0.15);
      --text-primary: #f5f5f7;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(255, 255, 255, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Background gradient */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 500px;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(234, 75, 113, 0.15), transparent);
      pointer-events: none;
      z-index: -1;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
    }

    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-primary);
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #ff6b9d);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
    }

    .nav {
      display: flex;
      gap: 8px;
    }

    .nav a {
      padding: 8px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .nav a:hover { color: var(--text-primary); background: var(--bg-card); }
    .nav a.active { color: var(--accent); background: var(--accent-soft); }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), #ff6b9d);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 32px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }

    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 16px;
    }

    .stat-icon.accent { background: var(--accent-soft); }
    .stat-icon.success { background: var(--success-soft); }
    .stat-icon.warning { background: var(--warning-soft); }
    .stat-icon.error { background: var(--error-soft); }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .stat-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      font-weight: 500;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stat-change.positive { color: var(--success); background: var(--success-soft); }
    .stat-change.negative { color: var(--error); background: var(--error-soft); }

    /* Charts Section */
    .section-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .card-body {
      padding: 24px;
    }

    /* Chart */
    .chart-container {
      height: 280px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding-top: 20px;
    }

    .chart-bar-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .chart-bars {
      display: flex;
      gap: 2px;
      height: 220px;
      align-items: flex-end;
    }

    .chart-bar {
      width: 12px;
      border-radius: 4px 4px 0 0;
      transition: all 0.3s ease;
      min-height: 4px;
    }

    .chart-bar.success { background: var(--success); }
    .chart-bar.failed { background: var(--error); }
    
    .chart-bar:hover {
      opacity: 0.8;
      transform: scaleY(1.02);
    }

    .chart-label {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Status Breakdown */
    .status-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.success { background: var(--success); }
    .status-dot.failed { background: var(--error); }
    .status-dot.running { background: var(--warning); }

    .status-info {
      flex: 1;
    }

    .status-name {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .status-count {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-bar-bg {
      width: 100px;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }

    .status-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .status-bar-fill.success { background: var(--success); }
    .status-bar-fill.failed { background: var(--error); }
    .status-bar-fill.running { background: var(--warning); }

    /* Recent Executions */
    .executions-table {
      width: 100%;
      border-collapse: collapse;
    }

    .executions-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
    }

    .executions-table td {
      padding: 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    .executions-table tr:last-child td { border-bottom: none; }

    .executions-table tr:hover td {
      background: var(--bg-card-hover);
    }

    .workflow-name {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .workflow-icon {
      width: 32px;
      height: 32px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.success { background: var(--success-soft); color: var(--success); }
    .status-badge.error, .status-badge.crashed { background: var(--error-soft); color: var(--error); }
    .status-badge.running { background: var(--warning-soft); color: var(--warning); }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .duration {
      color: var(--text-secondary);
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
    }

    .time-ago {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 60px 20px;
    }

    .error-icon {
      width: 64px;
      height: 64px;
      background: var(--error-soft);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin: 0 auto 20px;
    }

    .error-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .error-message {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover { background: #d63d62; transform: translateY(-1px); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .section-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .header { padding: 0 16px; }
      .main { padding: 20px 16px; }
      .nav { display: none; }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stagger-1 { animation-delay: 0.1s; opacity: 0; }
    .stagger-2 { animation-delay: 0.2s; opacity: 0; }
    .stagger-3 { animation-delay: 0.3s; opacity: 0; }
    .stagger-4 { animation-delay: 0.4s; opacity: 0; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">
        <div class="logo-icon">n8n</div>
        <span class="logo-text">Dashboard</span>
      </a>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/usage.html" class="active">Usage</a>
        <a href="/home/workflows" target="_blank">Workflows</a>
      </nav>
      <div class="user-info" id="userInfo" style="display: none;">
        <div class="user-avatar" id="userAvatar">?</div>
        <span class="user-name" id="userName">Loading...</span>
      </div>
    </div>
  </header>

  <main class="main" id="content">
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>Loading usage data...</p>
    </div>
  </main>

  <script>
    // Format relative time
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 }
      ];
      for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) return `${count} ${interval.label}${count > 1 ? 's' : ''} ago`;
      }
      return 'just now';
    }

    // Format duration
    function formatDuration(ms) {
      if (!ms) return '-';
      if (ms < 1000) return `${ms}ms`;
      if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
      return `${Math.floor(ms / 60000)}m ${Math.floor((ms % 60000) / 1000)}s`;
    }

    // Render dashboard
    function renderDashboard(data) {
      const { user, metrics, charts, recentExecutions } = data;
      
      // Update user info
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userAvatar').textContent = (user.firstName?.[0] || user.email[0]).toUpperCase();
      document.getElementById('userName').textContent = user.firstName || user.email.split('@')[0];

      // Calculate max for chart scaling
      const maxExecutions = Math.max(...charts.executionsByDay.map(d => d.total), 1);

      document.getElementById('content').innerHTML = `
        <h1 class="page-title">Usage Dashboard</h1>
        <p class="page-subtitle">Monitor your workflow executions, performance metrics, and resource usage</p>

        <div class="stats-grid">
          <div class="stat-card fade-in stagger-1">
            <div class="stat-icon accent">‚ö°</div>
            <div class="stat-value">${metrics.executions.total}</div>
            <div class="stat-label">Total Executions</div>
            <div class="stat-change positive">Last 100 runs</div>
          </div>
          <div class="stat-card fade-in stagger-2">
            <div class="stat-icon success">‚úì</div>
            <div class="stat-value">${metrics.executions.successRate}%</div>
            <div class="stat-label">Success Rate</div>
            <div class="stat-change ${metrics.executions.successRate >= 80 ? 'positive' : 'negative'}">
              ${metrics.executions.successful} successful
            </div>
          </div>
          <div class="stat-card fade-in stagger-3">
            <div class="stat-icon warning">‚è±</div>
            <div class="stat-value">${metrics.executionTime.totalFormatted}</div>
            <div class="stat-label">Total Run Time</div>
            <div class="stat-change positive">Avg: ${formatDuration(metrics.executionTime.averageMs)}</div>
          </div>
          <div class="stat-card fade-in stagger-4">
            <div class="stat-icon accent">üìã</div>
            <div class="stat-value">${metrics.workflows.total}</div>
            <div class="stat-label">Workflows</div>
            <div class="stat-change positive">${metrics.workflows.active} active</div>
          </div>
        </div>

        <div class="section-grid">
          <div class="card fade-in" style="animation-delay: 0.3s;">
            <div class="card-header">
              <h3 class="card-title">Execution History (Last 14 Days)</h3>
            </div>
            <div class="card-body">
              ${charts.executionsByDay.length > 0 ? `
                <div class="chart-container">
                  ${charts.executionsByDay.map(day => `
                    <div class="chart-bar-group">
                      <div class="chart-bars">
                        <div class="chart-bar success" style="height: ${(day.success / maxExecutions) * 200}px" title="${day.success} successful"></div>
                        <div class="chart-bar failed" style="height: ${(day.failed / maxExecutions) * 200}px" title="${day.failed} failed"></div>
                      </div>
                      <span class="chart-label">${new Date(day.date).toLocaleDateString('en', { month: 'short', day: 'numeric' })}</span>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="empty-state">
                  <div class="empty-icon">üìä</div>
                  <p>No execution data available yet</p>
                </div>
              `}
            </div>
          </div>

          <div class="card fade-in" style="animation-delay: 0.4s;">
            <div class="card-header">
              <h3 class="card-title">Status Breakdown</h3>
            </div>
            <div class="card-body">
              <div class="status-list">
                <div class="status-item">
                  <div class="status-dot success"></div>
                  <div class="status-info">
                    <div class="status-name">Successful</div>
                    <div class="status-count">${metrics.executions.successful} executions</div>
                  </div>
                  <div class="status-bar-bg">
                    <div class="status-bar-fill success" style="width: ${metrics.executions.total > 0 ? (metrics.executions.successful / metrics.executions.total * 100) : 0}%"></div>
                  </div>
                </div>
                <div class="status-item">
                  <div class="status-dot failed"></div>
                  <div class="status-info">
                    <div class="status-name">Failed</div>
                    <div class="status-count">${metrics.executions.failed} executions</div>
                  </div>
                  <div class="status-bar-bg">
                    <div class="status-bar-fill failed" style="width: ${metrics.executions.total > 0 ? (metrics.executions.failed / metrics.executions.total * 100) : 0}%"></div>
                  </div>
                </div>
                <div class="status-item">
                  <div class="status-dot running"></div>
                  <div class="status-info">
                    <div class="status-name">Running</div>
                    <div class="status-count">${metrics.executions.running} executions</div>
                  </div>
                  <div class="status-bar-bg">
                    <div class="status-bar-fill running" style="width: ${metrics.executions.total > 0 ? (metrics.executions.running / metrics.executions.total * 100) : 0}%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card fade-in" style="animation-delay: 0.5s;">
          <div class="card-header">
            <h3 class="card-title">Recent Executions</h3>
          </div>
          ${recentExecutions.length > 0 ? `
            <table class="executions-table">
              <thead>
                <tr>
                  <th>Workflow</th>
                  <th>Status</th>
                  <th>Duration</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody>
                ${recentExecutions.map(exec => `
                  <tr>
                    <td>
                      <div class="workflow-name">
                        <div class="workflow-icon">‚ö°</div>
                        ${exec.workflowName}
                      </div>
                    </td>
                    <td>
                      <span class="status-badge ${exec.status}">${exec.status}</span>
                    </td>
                    <td class="duration">${formatDuration(exec.duration)}</td>
                    <td class="time-ago">${timeAgo(exec.startedAt)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : `
            <div class="card-body">
              <div class="empty-state">
                <div class="empty-icon">üìú</div>
                <p>No recent executions</p>
              </div>
            </div>
          `}
        </div>
      `;
    }

    // Render error state
    function renderError(message) {
      document.getElementById('content').innerHTML = `
        <div class="error-state">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h2 class="error-title">Unable to Load Usage Data</h2>
          <p class="error-message">${message}</p>
          <a href="/" class="btn">‚Üê Back to Login</a>
        </div>
      `;
    }

    // Load usage data
    async function loadUsage() {
      try {
        const res = await fetch('/api/usage', { credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
          renderDashboard(data);
        } else {
          renderError(data.error || 'Please log in to view your usage statistics.');
        }
      } catch (err) {
        renderError('Failed to connect to the server. Please try again.');
      }
    }

    // Initialize
    loadUsage();
  </script>
</body>
</html>

