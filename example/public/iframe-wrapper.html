<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>n8n Iframe Wrapper</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #status {
      padding: 8px 12px;
      font-size: 14px;
      color: #555;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }
    #n8nContent {
      border: 0;
      width: 100%;
      flex: 1;
      display: none;
    }
  </style>
</head>
<body>
  <div id="status">Waiting for secure token from parent...</div>
  <div id="debug" style="padding:5px;background:#ffeb3b;font-size:12px;">DEBUG: v2 - iframe src will be set below</div>
  <iframe id="n8nContent" src=""></iframe>

  <script>
    const allowedOrigin = window.location.origin;
    const statusEl = document.getElementById('status');
    const contentFrame = document.getElementById('n8nContent');

    function postStatus(status, payload = {}) {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'IFRAME_STATUS', status, ...payload }, allowedOrigin);
      }
    }

    async function establishSession(token) {
      if (!token) return;
      statusEl.textContent = 'Syncing session with n8n...';

      try {
        const response = await fetch('/api/iframe/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token })
        });
        const data = await response.json();

        if (response.ok && data.success) {
          statusEl.textContent = `Connected as ${data.email} - Loading n8n...`;
          document.getElementById('debug').textContent = `DEBUG: Setting src to /n8n/`;
          contentFrame.style.display = 'block';
          contentFrame.src = '/n8n/';
          document.getElementById('debug').textContent = `DEBUG: src is now: ${contentFrame.src}`;
          postStatus('AUTH_SUCCESS', { email: data.email });
        } else {
          const errorMsg = data.error || 'Failed to sync session';
          statusEl.textContent = errorMsg;
          postStatus('AUTH_FAILED', { error: errorMsg });
        }
      } catch (error) {
        statusEl.textContent = 'Session sync failed. See console.';
        postStatus('AUTH_FAILED', { error: error.message });
        console.error('Iframe session error:', error);
      }
    }

    window.addEventListener('message', (event) => {
      if (event.origin !== allowedOrigin) return;
      const { type, token } = event.data || {};
      if (type === 'AUTH_TOKEN') {
        establishSession(token);
      }
    });

    contentFrame.addEventListener('load', () => {
      statusEl.textContent = statusEl.textContent.replace('Loading n8n...', 'n8n loaded');
    });

    window.addEventListener('DOMContentLoaded', () => {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'IFRAME_READY' }, allowedOrigin);
      } else {
        statusEl.textContent = 'This page is intended to be embedded.';
      }
    });
  </script>
</body>
</html>

